<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ILP Live Drone Visualiser</title>
    <link
            rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
            crossorigin=""/>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>

    <style>
        #map { height: 100vh; }
    </style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<script>
    var map = L.map('map').setView([55.94466, -3.186824], 13);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    const stompClient = new StompJs.Client({
        webSocketFactory: () => new SockJS("http://localhost:8080/websocket"),
        reconnectDelay: 5000,
        onConnect: () => {
            console.log('Connected to WebSocket');

            stompClient.subscribe("/topic/drones", message => {
                console.log(`Received: ${message.body}`);

                const data = JSON.parse(message.body);
                updateDrone(data);
                }
            );

        },
    });
    stompClient.activate();


    // ------- Drone visualisation -------
    const dronesInfo = new Map();
    function updateDrone(data) {
        const droneId = data.droneId;
        const position = [data.position.lat, data.position.lng]; // [lat, lng]

        if (!dronesInfo.has(droneId)) {

            const marker = L.circle(position, {
                color: '#0072B2',
                fillColor: '#56B4E9',
                fillOpacity: 0.5,
                radius: 17
            }).addTo(map);

            marker.bindTooltip(`Drone ${droneId}`); // show drone id when hover

            map.setView(position, 16); // zoom into the point

            const path = [position];
            const polyline = L.polyline(path, {
                color: "blue",
                weight: 3
            }).addTo(map);
            polyline.bindTooltip(`Drone ${droneId} path`);

            dronesInfo.set(droneId, {marker, path, polyline})
        }
        else {
            const droneInfo = dronesInfo.get(droneId);

            droneInfo.marker.setLatLng(position);
            droneInfo.path.push(position);
            droneInfo.polyline.setLatLngs(droneInfo.path);
            droneInfo.polyline.setStyle({color: getColour(data.status)});
        }
    }

    function getColour(droneStatus) {
        switch(droneStatus) {
            case "FLYING": return '#0072B2'; // blue
            case "IDLE": return '#009E73'; // green
            // case "FAILED": return '#E69F00'; // orange
            default: return '#C13C48'; //red
        }
    }

</script>

</body>
</html>