<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ILP Live Drone Visualiser</title>
    <link
            rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
            crossorigin=""/>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>

    <style>
        #container {
            display: flex;
            flex-direction: row;
            height: 100vh;
            width: 100%;
        }

        #map {
            flex: 3;
            height: 100%;
        }

        #drone-panel {
            flex: 1;
            background: cornsilk;
            border-left: 1px solid blanchedalmond;
            padding: 10px;
            overflow-y: auto;
        }

        .drone-card {
            background: aliceblue;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            font-family: Arial, Helvetica, sans-serif;
        }

        .drone-button {
            background: ghostwhite;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }

        .drone-button:hover {
            background-color: lightgrey;
        }

        .warning {
            color: red;
            font-weight: bold;
        }

    </style>
</head>
<body>
<div id="container">
    <div id="map"></div>
    <div id="drone-panel">
        <h2>Drone Status</h2>
        <div id="drone-list"></div>
    </div>
</div>


<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<script>
    var map = L.map('map').setView([55.94466, -3.186824], 13);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    const stompClient = new StompJs.Client({
        webSocketFactory: () => new SockJS("/websocket"),
        reconnectDelay: 5000,
        onConnect: () => {
            console.log('Connected to WebSocket');

            stompClient.subscribe("/topic/drones", message => {
                console.debug(`Received: ${message.body}`);

                const data = JSON.parse(message.body);
                updateDrone(data);
                updateDronePanel(data);
                }
            );

        },
    });
    stompClient.activate();


    // ------- Drone visualisation -------
    // map droneId to marker, path, polyline
    const dronesInfo = new Map();
    function updateDrone(data) {
        const droneId = data.droneId;

        if (data.status == "IDLE") {
            console.log(`Drone ${data.droneId} has finished.`);

            const infoMapping = dronesInfo.get(droneId);
            if (infoMapping) {
                // remove the mapping
                map.removeLayer(infoMapping.marker);
                map.removeLayer(infoMapping.polyline);
                dronesInfo.delete(droneId);
            }

            removeDroneCard(droneId);
            return;
        }

        if (!data.position) {
            console.warn(`Drone ${data.droneId} has no position (status = ${data.status})`)
        }
        const position = [data.position.lat, data.position.lng]; // [lat, lng]

        if (!dronesInfo.has(droneId)) {

            const marker = L.circle(position, {
                color: '#0072B2',
                fillColor: '#56B4E9',
                fillOpacity: 0.5,
                radius: 17
            }).addTo(map);

            marker.bindTooltip(`Drone ${droneId}`); // show drone id when hover

            map.setView(position, 16); // zoom into the point

            const path = [position];
            const polyline = L.polyline(path, {
                color: "blue",
                weight: 3
            }).addTo(map);
            polyline.bindTooltip(`Drone ${droneId} path`);

            dronesInfo.set(droneId, {marker, path, polyline})
        }
        else {
            const droneInfo = dronesInfo.get(droneId);

            droneInfo.marker.setLatLng(position);
            droneInfo.path.push(position);
            droneInfo.polyline.setLatLngs(droneInfo.path);
            droneInfo.polyline.setStyle({color: getColour(data.status)});
        }
    }

    function getColour(droneStatus) {
        switch(droneStatus) {
            case "FLYING": return '#0072B2'; // blue
            case "IDLE": return '#009E73'; // green
            // case "FAILED": return '#E69F00'; // orange
            default: return '#C13C48'; //red
        }
    }

    // Drone Panel
    function updateDronePanel(data) {
        const droneId = data.droneId;
        const entryId = `drone-${droneId}`;

        if (data.status === "IDLE") {
            removeDroneCard(droneId);
            return;
        }

        let card = document.getElementById(entryId);
        // creat card if not exist
        if (!card) {
            card = document.createElement('div');
            card.className = 'drone-card';
            card.id = entryId;
            card.innerHTML = `
                <h3>
                    <button class="drone-button" onclick="focusDrone('${droneId}')">
                        Drone ${droneId}
                    </button>
                </h3>
                <p>Status:<span class="status-text"></span></p>
                <p>Position: <span class="pos-text"></span></p>
                <p class="move-warning"></p>
                <p>Dispatch ID: <span class="dispatch-text"></span></p>
            `;
            document.getElementById("drone-list").appendChild(card);
        }

        // update fields
        card.querySelector(".status-text").textContent = data.status;
        card.querySelector(".status-text").style.color = getColour(data.status);
        // round position to 5 dp
        card.querySelector(".pos-text").textContent =
            `lat=${data.position.lat.toFixed(5)},
             lng=${data.position.lng.toFixed(5)}`;

        if (data.remainingMoves < 10) {
            card.querySelector(".move-warning").innerHTML =
                `<span class="warning"> Low remaining moves:
                ${data.remainingMoves}</span>`;
        } else {
            // if undefined show "?"
            card.querySelector(".move-warning").textContent =
                `Remaining moves: ${data.remainingMoves ?? "?"}`;
        }

        card.querySelector(".dispatch-text").textContent = data.dispatchId ?? "?";
    }

    function removeDroneCard(droneId) {
        const entryId = `drone-${droneId}`;
        const card = document.getElementById(entryId);
        if (card) {
            card.remove();
        }
    }

    function focusDrone(droneId) {
        const infoMapping = dronesInfo.get(droneId);
        if (infoMapping) {
            // get last position
            const lastPos = infoMapping.path[infoMapping.path.length - 1];
            map.setView(lastPos, 16);
        }
        else {
            console.warn(`Drone ${droneId} not found.`);
        }
    }

</script>

</body>
</html>